{% extends "base.html" %}
{% block content %}

<style>
.triangle-left{
  width: 0;
  height: 0;
  border-top: 10px solid transparent;
  border-right: 10px solid black;
  border-bottom: 10px solid transparent;
  display: inline-block;
}

.triangle-right{
  width: 0;
  height: 0;
  border-left: 10px solid black;
  border-top: 10px solid transparent;
  border-bottom: 10px solid transparent;
  display: inline-block;
}

 .triangle-link {
    display: inline-block;
    text-decoration: none;
 }

 .table-container {
  
  
  max-height: 600px;
  margin-top: 20px;
}

table {
  width: 100%;
  min-width: auto;
  {% comment %} table-layout: auto; {% endcomment %}
  font-size: 14px;
  border-spacing: 0;
  table-layout: fixed; 
  
}

th, td {
  border: 1px solid #8d8c89e9;
  padding: 8px 12px;
  vertical-align: top;
  word-break: break-word;
  white-space: normal;
  overflow-wrap: break-word;
  line-height: 1.2;
  height: 80px;
  max-height: 80px;
  
}


thead th {
    vertical-align: middle;
    {% comment %} background-color: rgb(190, 250, 250); {% endcomment %}
    font-weight: bold;
    text-align: center;
    padding: 5px;
    height: 60px;
    font-size: 16px;
    position: sticky;
    top: 0;
    {% comment %} z-index: 1; {% endcomment %}
    background: none;
    border-top: none;
    border-bottom: none;
    {% comment %} border: 1px solid #8d8c89e9; {% endcomment %}
}

thead th::before {
    content: "";
    width: 100%;
    height: 100%;
    {% comment %} display: block; {% endcomment %}
    {% comment %} border: 1px solid #8d8c89e9; {% endcomment %}
    position: absolute;
    top: 0px;
    left: 0px;
    box-sizing: content-box;
    z-index: -1;
    border-top: 1px solid #8d8c89e9;
    border-bottom: 1px solid #8d8c89e9;
    background-color: rgb(190, 250, 250);
  }




.col-1 { width: 8%; }
.col-2 { width: 8%; }
.col-3 { width: 8%; }
.col-4 { width: 8%; }
.col-5 { width: 8%; }
.col-6 { width: 8%; }
.col-7 { width: 8%; }
.col-8 { width: 14%; }
.col-9 { width: 14%; }
.col-10 { width: 16%; }



{% comment %} .th:before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-top: 1px solid #8d8c89e9;
  border-bottom: 1px solid #8d8c89e9;
  background: #befafaff;
  z-index: -1;
} {% endcomment %}


th:first-child {
  background-color: rgb(190, 250, 250); /* 1列目も背景を固定 */
  position: sticky;
  top: 0px;
  /* ヘッダーより上にする */
}

td {
    max-height: 100px;
    background-color: #ffffff;
    border: 1px solid #8d8c89e9;
  

}

.navigation h5 {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.container.text-center h5 {
  margin-top: 10px;
  margin-bottom: 10px;
}

.button-group {
  margin-top: 20px;
  margin-bottom: 20px;
}


p {
    margin-top: 20px;
    margin-bottom: 30px;
  }

h5{
    margin-top: 20px;
}

.btn  {
  min-width: 100px;
  gap: 10px;
  padding: 10px 25px;
  font-size: 1.2rem;
  border-radius: 5px;
  border: 1px solid #ccc;
}

.btn-input-edit{
  background-color: #007bff;
  color: white;
}

.btn-input-edit:hover{
  background-color: #449cfbff;
  color: white;
  transition: 0.2s ease;
}

.btn-cancel {
  background-color: #b4b4b4ff;
  color: #333;
}

.btn-cancel:hover {
  background-color: #c7c7c7ff;
  color: #333;
  transition: 0.2s ease;
}

.btn-cancel-modal{
  background-color: #b4b4b4ff;
  padding: 10px 25px;
  color: #333;
}

.btn-cancel-modal:hover {
  background-color: #c7c7c7ff;
  color: #333;
  transition: 0.2s ease;
}


.btn-delete {

  background-color: #c82333;
  padding: 15px 55px;
  color: white;
}

.btn-delete:hover  {
  background-color: #dc3545;
  color: white;
  transition: 0.2s ease;
}

.btn-delete-modal{
  background-color: #c82333;
  padding: 10px 38px;
  color: white;
}

.btn-delete-modal:hover {
  background-color: #dc3545;
  color: white;
  transition: 0.2s ease;
}

#emptyModal button {
  padding: 12px 30px;
  font-size: 18px;
  background-color: #8d8c89e9;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);

}

#emptyModal button:hover {
  background-color: #c5c4c2e9;!important;
  color: white;
  transition: 0.2s ease;
}

.container-bottom-space {
  padding-bottom: 50px;
}


</style>

<h4>{{ year }}年{{ month }}月の振り返り</h4>

<div class="container container-bottom-space">
  <div class="container  text-center">
  {% if messages %}
    {% for message in messages %}
    <p>{{ message.message}}</p>
    {% endfor %}
  {% endif %}
  </div>

  <div class="navigation">
    <h5>
        <a href="{% url 'diary_app:reflection' month_previous.year month_previous.month %}"  class="triangle-link">
             <div class="triangle-left"></div>
        </a>
         {{ month_current | date:"Y年m月"}}

        <a href="{% url 'diary_app:reflection' month_next.year month_next.month %}" class="triangle-link">
             <div class="triangle-right"></div>
        </a>
      </h5>
  </div>


<h5>1週間ごとの振り返り</h5>
<div class="d-flex justify-content-end mb-2">
  <button type="button" class="btn btn- btn btn-input-edit"
        onclick="location.href='{% url 'diary_app:edit_reflection' year=year month=month %}'">
    振り返りを入力・編集
  </button>
</div>
<div class="table-container">
<table>
    {% comment %} <colgroup>
    <col span="7" style="width: 7%;">
    <col style="width: 10%;">
    <col style="width: 10%;">
    <col style="width: 10%;">
    </colgroup> {% endcomment %}
    <thead>
        <tr>
          <th class="col-1">月</th>
          <th class="col-2">火</th>
          <th class="col-3">水</th>
          <th class="col-4">木</th>
          <th class="col-5">金</th>
          <th class="col-6">土</th>
          <th class="col-7">日</th>
          <th class="col-8">今週のハイライト</th>
          <th class="col-9">できた理由</th>
          <th class="col-10">今後はどのような<br>工夫をしたらよいか</th>
        </tr>
    </thead>
    <tbody>
         {% for week_num, data in weeks.items %}
          <tr>
              {% for day,diary in data.days_diaries %}
                  <td>
                    {% if month_current.month != day.month %}
                      <div style= "font-size:14px; color:#B0C4DE; margin-bottom:5px;font-weight: bold; ">{{ day.day }}</div>
                    {% else %}
                      <div style= "font-size:14px; color:#0000EE; margin-bottom:5px; font-weight: bold;">{{ day.day }}</div>
                    {% endif %}
                    {% if diary %}
                      {% for success in diary.success_list %}
                        <span style="white-space: nowrap;">・{{ success.label|slice:":1" }}</span>{{ success.label|slice:"1:" }}<br>
                      {% endfor %}
                    {% endif %}
                  </td>
              {% endfor %}
               <td>{{ data.reflection.highlight|default_if_none:""|linebreaksbr }}</td>
               <td>{{ data.reflection.reason|default_if_none:""|linebreaksbr }}</td>
               <td>{{ data.reflection.next_plan|default_if_none:""|linebreaksbr }}</td>
          </tr>
          {% endfor %}
    </tbody>
</table>
</div>
<h5>今月の振り返り</h5>
  <div style="margin-top: 30px;">
      <p><strong>■各週のハイライトに共通する点</strong><br>
      {% if month_reflection and month_reflection.common_ground %}
        <p>{{ month_reflection.common_ground|default_if_none:""|linebreaksbr }}</p>
      {% else %}
        <p>まだ記入されていません。</p>
      {% endif %}
      <p><strong>■自分の価値観や大切にしていること</strong><br>
      {% if month_reflection and month_reflection.my_values  %}
        <p>{{ month_reflection.my_values|default_if_none:""|linebreaksbr }}</p>
      {% else %}
        <p>まだ記入されていません。</p>
      {% endif %}
      <p><strong>■その他気づいたこと</strong><br>
      {% if month_reflection and month_reflection.awareness %}
        <p>{{ month_reflection.awareness|default_if_none:""|linebreaksbr }}</p>
      {% else %}
        <p>まだ記入されていません。</p>
      {% endif %}
  </div>

  <div class="button-group">
  {% if month_reflection or  data.reflection %}
    <button type="button" class="btn btn-delete" data-bs-toggle="modal" data-bs-target="#deleteModal-{{diary.id}}">
      削除
    </button>
  {% else %}
    <button type="button" class="btn btn-delete" data-bs-toggle="modal" data-bs-target="#emptyModal">
      削除
    </button>
  {% endif %}
  </div>
</div>

          <div class="modal fade" tabindex="-1" role="dialog" id="deleteModal-{{diary.id}}">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">1週間・1ヶ月の振り返りを削除</h5>
                </div>
                <div class="modal-body">
                  <p>削除すると元に戻すことはできません。削除してもよろしいでしょうか？</p>
                </div>
                <div class="modal-footer">
                  <form method="POST" action="{% url 'diary_app:delete_reflection' year=year month=month %}">
                    {% csrf_token %}
                    <button type="button" class="btn btn-cancel-modal" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-delete-modal">削除</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" tabindex="-1" role="dialog" id="emptyModal">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">まだ記録がありません</h5>
                </div>
                <div class="modal-body">
                  <p>この日の記録はまだありません。削除する内容がありません。</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
              </div>
            </div>
          </div>


{% endblock %}


