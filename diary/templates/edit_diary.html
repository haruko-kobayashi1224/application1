{% extends "base.html" %}
{% block content %}

<style>
.other-success-form {
    flex: 0 0 auto;
  }

    h4 {
    margin-top: 30px;
    margin-bottom: 15px;
  }

  .checkbox-inline {
    display: inline-block;
    margin-right: 15px;
    margin-bottom: 10px;
  }

  .formset-flex {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
    margin-bottom: 20px;
  }

  .other-success-form {
    flex: 0 0 auto;
    margin-bottom: 10px;
  }

  
  .button-area {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  #add-form-btn,
  input[type="submit"] {
    font-size: 1.1rem;
    padding: 10px 25px;
    border-radius: 5px;
    border: 1px solid #ccc;
    
  }

  #add-form-btn {
    background-color: #E0FFFF;
    color: black;
  }

  input[type="submit"] {
    background-color: #007bff;
    color: white;
  }

  .btn-cancel,
input[type="submit"] {
  font-size: 1.1rem;
  padding: 10px 25px;
  border-radius: 5px;
  border: 1px solid #ccc;
}

</style>

{% if formset.non_form_errors %}
    <div>
      {% for error in formset.non_form_errors %}
          <p>{{ error}}</p>
      {% endfor%}
    </div> 
{% endif %}
    <h4>できたこと編集</h4>
    <h4>{{ year }}年{{ month }}月{{ day }}日{{ weekday_jp  }}曜日</h4>
    <form method="POST">    
        {% csrf_token %}
        <h5>今日できたこと</h5>
        <div class="formset-flex">
          {% for checkbox in edit_diary_form.successes %}
            <label class="checkbox-inline">
              {{ checkbox.tag }} {{ checkbox.choice_label }}
            </label>
          {% endfor %}
        </div>
          {{ formset.management_form }}   
        <div id="formset-area">
          <div class="formset-flex" id="formset-container"> 
            {% for form in formset %}
            <div class="other-success-form">
                {{ form.other_success }}
            </div>
            {% endfor %}
          </div>  
        </div>
        <div style="text-align: center; margin-bottom: 20px;">
          <button type="button" id="add-form-btn" >＋追加</button>        
        </div>
        <h5>明日の目標</h5>
        {{ edit_diary_form.tomorrow_goal }}
        <div class="button-area">
          <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ diary.id }}">
            削除
          </button> 
          <input type="submit" value="保存" class="btn btn-primary btn-sm">
        </div> 
        <button type="button" class="btn-cancel" onclick="location.href='{% url 'diary_app:month' year=today.year month=today.month %}'">
           キャンセル
        </button>    
    </form>      



<script>
    document.addEventListener('DOMContentLoaded', function(){
        const addButton = document.getElementById("add-form-btn");    
        const formContainer = document.getElementById("formset-container");
        let formCount = {{ formset.total_form_count }};
        const maxForms =3;

        const originalForm = formContainer.children[0].cloneNode(true);

        addButton.addEventListener("click", function(){
            if (formCount >= maxForms) {
                alert("これ以上追加できません（最大3つ）");
                return;
            }
        
             const newForm = originalForm.cloneNode(true);
             newForm.innerHTML = newForm.innerHTML.replace(/form-0-/g, `form-${formCount}-`)
             formContainer.appendChild(newForm);
             
             const totalForms = document.querySelector("#id_form-TOTAL_FORMS");
             totalForms.value =formCount + 1;
             formCount++;

        });   
    });        
</script>
<div class="modal fade" tabindex="-1" role="dialog" id="deleteModal-{{ diary.pk }}">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">今日できたこと日記の削除</h5>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
      </div>
      <div class="modal-body">
        <p>削除すると元に戻すことはできません。よろしいでしょうか？</p>
      </div>
      <div class="modal-footer">
        {% if diary.pk %}
          <form action="{% url 'diary_app:delete_diary' pk=diary.pk year=diary.created_at.year month=diary.created_at.month day=diary.created_at.day %}" method="POST">
            {% csrf_token %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
              <button type="submit" class="btn btn-danger">削除</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}